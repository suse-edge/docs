== Helm chart upgrade
:experimental:

ifdef::env-github[]
:imagesdir: ../images/
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:toc: auto

[NOTE]
====
The below sections focus on using `Fleet` functionalities to achieve a Helm chart update.

Users adopting a third-party GitOps workflow, should take the configurations for their desired helm chart from its `fleet.yaml` located at `fleets/day2/chart-templates/<chart-name>`. *Make sure you are retrieving the chart data from a valid "Day 2" Edge link:https://github.com/ipetrov117/fleet-examples/releases[release].*
====

=== Components

* <<components-rancher,Rancher>> - Located on the <<day2-mgmt-cluster,Rancher Management Cluster>>; responsible for the downstream cluster management.

* <<components-fleet,Fleet>> - Service offered by the `Rancher` component; responsible for muti-cluster resource deployment. It is assumed that existing charts are deployed with Fleet.

=== Preparation for air-gapped environments

==== Ensure that you have access to your Helm chart's upgrade `fleet.yaml` file

Host the needed resources on a local git server that is accessible by your *Rancher Management Cluster*.

==== Find the required assets for your Edge release version

. Go to our Day 2 link:https://github.com/ipetrov117/fleet-examples/releases[release] page and find the Edge 3.X.Y release that you want to upgrade your chart to and click *Assets*.

. From the release's *Assets* section, download the following files, which are required for an air-gapped upgrade of a SUSE supported helm chart:
+
[cols="1,1"]
|======
|*Release File* 
|*Description*

|_edge-save-images.sh_
|This script pulls the images in the `edge-release-images.txt` file and saves them to a '.tar.gz' archive that can then be used in your air-gapped environment.

|_edge-save-oci-artefacts.sh_
|This script pulls the SUSE OCI chart artefacts in the `edge-release-helm-oci-artefacts.txt` file and creates a '.tar.gz' archive of a directory containing all other chart OCI archives.

|_edge-load-images.sh_
|This script loads the images in the '.tar.gz' archive generated by `edge-save-images.sh`, retags them and pushes them to your private registry.

|_edge-load-oci-artefacts.sh_
|This script takes a directory containing '.tgz' SUSE OCI charts and loads all OCI charts to your private registry. The directory is retrieved from the '.tar.gz' archive that the `edge-save-oci-artefacts.sh` script has generated.

|_edge-release-helm-oci-artefacts.txt_
|This file contains a list of OCI artefacts for the SUSE Edge release Helm charts.

|_edge-release-images.txt_
|This file contains a list of images needed by the Edge release Helm charts.
|======

==== Create the SUSE Edge release images archive

_On a machine with internet access:_

. Make `edge-save-images.sh` executable:
+
[,bash]
----
chmod +x edge-save-images.sh
----

. Use `edge-save-images.sh` script to create a _Docker_ importable '.tar.gz' archive:
+
[,bash]
----
./edge-save-images.sh --source-registry registry.suse.com
----

. This will create a ready to load `edge-images.tar.gz` (unless you have specified the `-i|--images` option) archive with the needed images

. Copy this archive to your *air-gapped* machine

==== Create a SUSE Edge Helm chart OCI images archive

_On a machine with internet access:_

. Make `edge-save-oci-artefacts.sh` executable:
+
[,bash]
----
chmod +x edge-save-oci-artefacts.sh
----

. Use `edge-save-oci-artefacts.sh` script to create a '.tar.gz' archive of all SUSE Edge Helm chart OCI images:
+
[,bash]
----
./edge-save-oci-artefacts.sh --source-registry registry.suse.com
----

. This will create a `oci-artefacts.tar.gz` archive containing all SUSE Edge Helm chart OCI images

. Copy this archive to your *air-gapped* machine

==== Load SUSE Edge release images to your air-gapped machine

_On your air-gapped machine:_

. Log into your private registry (if required):
+
[,bash]
----
docker login <REGISTRY.YOURDOMAIN.COM:PORT>
----

. Make `edge-load-images.sh` executable:
+
[,bash]
----
chmod +x edge-load-images.sh
----

. Use `edge-load-images.sh` to load the images from the *copied* `edge-images.tar.gz` archive, retag them and push them to your private registry:
+
[,bash]
----
./edge-load-images.sh --source-registry registry.suse.com --registry <REGISTRY.YOURDOMAIN.COM:PORT> --images edge-images.tar.gz
----

==== Load SUSE Edge Helm chart OCI images to your air-gapped machine

_On your air-gapped machine:_

. Log into your private registry (if required):
+
[,bash]
----
docker login <REGISTRY.YOURDOMAIN.COM:PORT>
----

. Make `edge-load-oci-artefacts.sh` executable:
+
[,bash]
----
chmod +x edge-load-oci-artefacts.sh
----

. Untar the copied `oci-artefacts.tar.gz` archive:
+
[,bash]
----
tar -xvf oci-artefacts.tar.gz
----

. This will produce a directory with the naming template `edge-release-oci-tgz-<date>`

. Pass this directory to the `edge-load-oci-artefacts.sh` script to load the SUSE Edge helm chart OCI images to your private registry:
+
[NOTE]
====
This script assumes the `helm` CLI has been pre-installed on your environment. For Helm installation instructions, see link:https://helm.sh/docs/intro/install/[Installing Helm].
====
+
[,bash]
----
./edge-load-oci-artefacts.sh --archive-directory edge-release-oci-tgz-<date> --registry <REGISTRY.YOURDOMAIN.COM:PORT> --source-registry registry.suse.com
----

==== Create registry mirrors pointing to your private registry for your Kubernetes distribution

For RKE2, see link:https://docs.rke2.io/install/containerd_registry_configuration[Containerd Registry Configuration]

For K3s, see link:https://docs.k3s.io/installation/registry-mirror[Embedded Registry Mirror]

=== Upgrade procedure

[NOTE]
====
The below upgrade procedure utilises Rancher's <<components-fleet,Fleet>> funtionality. Users using a third-party GitOps workflow should retrieve the chart versions supported by each Edge release from the <<release_notes>> and populate these versions to their third-party GitOps workflow.
====

This section focuses on the following Helm upgrade procedure use-cases:

. _I have a new cluster and would like to deploy and manage a SUSE Helm chart_

. _I would like to upgrade a Fleet managed Helm chart_

. _I would like to upgrade a manually deployed Helm chart_

==== I have a new cluster and would like to deploy and manage a SUSE Helm chart

For users that want to manage their Helm chart lifecycle through Fleet.

===== Prepare your Fleet resources

. Acquire the Chart's Fleet resources from the Edge link:https://github.com/ipetrov117/fleet-examples/releases[release] tag that you wish to use

.. From the selected Edge release tag revision, navigate to the Helm chart fleet - `fleets/day2/chart-templates/<chart>`

.. Copy the chart Fleet directory to the Git repository that you will be using for your GitOps workflow

.. *Optionally*, if the Helm chart requires configurations to its *values*, edit the `.helm.values` configuration inside the `fleet.yaml` file of the copied directory

.. *Optionally*, there may be use-cases where you need to add additional resources to your chart's fleet so that it can better fit your environment. For information on how to enhance your Fleet directory, see link:https://fleet.rancher.io/gitrepo-content[Git Repository Contents]

An *example* for the `metal3` helm chart would look like:

* User Git repository strucutre:
+
[,bash]
----
<user_repository_root>
└── metal3
    └── fleet.yaml
----

* `fleet.yaml` content populated with user `metal3` data:
+
[,yaml]
----
defaultNamespace: metal3-system

helm:
  releaseName: metal3
  chart: "oci://registry.suse.com/edge/metal3-chart"
  version: "0.6.5"
  # custom chart value overrides
  values: 
    global:
      ironicIP: "192.168.122.76"
      enable_tls: false
      enable_vmedia_tls: false
      enable_basicAuth: false
      provisioningInterface: "eth0"
    metal3-ironic:
      persistence:
        ironic:
          storageClass: "longhorn"
    metal3-mariadb:
      persistence:
        storageClass: "longhorn"
----
+
[NOTE]
====
These are just example values that are used to illustrate custom configurations on the `metal3` chart. They should *NOT* be treated as deployment guidelines for the `metal3` chart.
====

===== Create the GitRepo

After populating your repository with the chart's Fleet resources, you must create a link:https://fleet.rancher.io/ref-gitrepo[GitRepo] resource. This resource will hold information on how to access your chart's Fleet resources and to which clusters it needs to apply those resources.

The `GitRepo` resource can be created through the Rancher UI, or by manually deploying the resource to the *Rancher Management Cluster*.

For information on how to create and deploy the GitRepo resource *manually*, see link:https://fleet.rancher.io/tut-deployment[Creating a Deployment].

To create a `GitRepo` resource through the *Rancher UI*, see link:https://ranchermanager.docs.rancher.com/v2.8/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui[Accessing Fleet in the Rancher UI].

_Example *metal3* `GitRepo` resource for *manual* deployment:_

[,yaml]
----
apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: metal3-git-repo
  namespace: fleet-default
spec:
  # If using a tag
  # revision: <user_repository_tag>
  # 
  # If using a branch
  # branch: <user_repository_branch>
  paths:
  # As seen in the 'Prepare your Fleet resources' example
  - metal3
  repo: <user_repository_url>
  targets:
  # Match all clusters
  - clusterSelector: {}
----

===== Managing the deployed Helm chart

Once deployed with Fleet, for Helm chart upgrades, see <<upgrade_fleet_managed_chart>>.

[#upgrade_fleet_managed_chart]
==== I would like to upgrade a Fleet managed Helm chart

. Determine the version to which you need to upgrade your chart so that it is compatible with an Edge 3.X.Y release. Helm chart version per Edge release can be viewed from the <<release_notes>>.

. In your Fleet monitored Git repository, edit the Helm chart's `fleet.yaml` file with the correct chart *version* and *repository* from the <<release_notes>>.

. After commiting and pushing the changes to your repository, this will trigger an upgrade of the desired Helm chart

==== I would like to upgrade a manually deployed Helm chart

To update an existing manually deployed Helm chart, users should create a Fleet link:https://fleet.rancher.io/bundle-add[Bundle] containing a link:https://github.com/k3s-io/helm-controller#helm-controller[Helm chart resource definition] configuration.

You can retrieve the *Bundle* from https://raw.githubusercontent.com/ipetrov117/fleet-examples/$\{REVISION\}/bundles/day2/chart-template/helm-chart-bundle.yaml, where `$\{REVISION\}` is the Edge link:https://github.com/ipetrov117/fleet-examples/releases[release] tag that you want to use.

If your chart requires overrides to its default values, make sure to add them to the `HelmChart` resource inside the `Bundle`. For additional information on `HelmChart` CR configuration, see the `HelmChart` field definitions for both link:https://docs.rke2.io/helm#helmchart-field-definitions[RKE2] and link:https://docs.k3s.io/helm#helmchart-field-definitions[K3s].

[IMPORTANT]
====
To ensure a successful upgrade, the `HelmChart` *name* and *namespace* must be the same as the Helm chart that has been *manually* deployed.
====

[IMPORTANT]
====
A Helm chart upgrade using this method can *only* be performed if the upgrade is done from the same repository from which the original chart was deployed. If the repository is changed, this will cause a *replace* of the chart instead of an *upgrade*.
====

An example of both upgrading and replacing a manually deployed helm chart can be seen in the section below.

===== Example

A cluster (named `rke2-slemicro`) has the following manually deployed Helm charts:

* link:https://longhorn.io[Longhorn] Helm chart with version `1.5.5` deployed from `https://charts.longhorn.io`

* link:https://book.metal3.io/introduction.html[Metal3] Helm chart with version `0.6.0` deployed from `https://suse-edge.github.io/charts`
+
.Helm charts as seen in Rancher
image::day2-helm-upgrade-1.png[]

We want to upgrade these charts so that they are compatible with an Edge "Day 2" 3.0.0 release.

To do this, we must:

. Locate the Edge "Day 2" 3.0.0 release in the `suse-edge/fleet-examples` link:https://github.com/ipetrov117/fleet-examples/releases[releases]

. To know the correct Helm chart versions and repositories for a specific Helm chart, navigate to the Edge <<release_notes>>. From here we can see:

** `Longhorn` chart information:

*** Version: `1.6.1`

*** Repo: `https://charts.longhorn.io`

** `Metal3` chart information:

*** Version: `0.6.5`

*** Repo: `oci://registry.suse.com/edge/metal3-chart`
+
Note here how the Helm chart repository is different from the repository that we have deployed our `Metal3` from. Using this repo with the steps below we will trigger a *replacement* of the existing Helm chart with the Helm chart from the `OCI` registry.

*** Custom value overrides:
+
[,yaml]
----
global:
  ironicIP: "192.168.122.76"
  enable_tls: false
  enable_vmedia_tls: false
  enable_basicAuth: false
  provisioningInterface: "eth0"
metal3-ironic:
  persistence:
    ironic:
      storageClass: "longhorn"
metal3-mariadb:
  persistence:
    storageClass: "longhorn"
----

** Alternatively the correct Helm chart version and repository data can be retrieved from the `suse-edge/fleet-examples` link:https://github.com/ipetrov117/fleet-examples/releases[release] tag under `.helm` specification of the `fleets/day2/chart-templates/<chart>/fleet.yaml` file.

. Retrieve the `Bundle` template for the Edge "Day 2" 3.0.0 `suse-edge/fleet-examples` link:https://github.com/ipetrov117/fleet-examples/releases[release]:
+
[,bash]
----
curl -o bundle-template.yaml https://raw.githubusercontent.com/ipetrov117/fleet-examples/edge-3.0.0/bundles/day2/chart-template/helm-chart-bundle.yaml
----

. From the `Bundle` template create:

** One `Bundle` for `Longhorn`:
+
.longhorn-bundle.yaml
[,yaml]
----
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: longhorn-helm-chart-bundle
  namespace: fleet-default
spec:
  resources:
  - content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: longhorn
        namespace: longhorn-system
      spec:
        repo: "https://charts.longhorn.io"
        chart: longhorn
        version: "1.6.1"
    name: longhorn-helm-chart-bundle.yaml
  targets:
  # Match to your desired cluster, in this case
  # we match only to one cluster
  - clusterName: rke2-slemicro
----

** One `Bundle` for `Metal3`:
+
.metal3-bundle.yaml
[,yaml]
----
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: metal3-helm-chart-bundle
  namespace: fleet-default
spec:
  resources:
  - content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: metal3
        namespace: metal3-system
      spec:
        chart: oci://registry.suse.com/edge/metal3-chart
        version: "0.6.5"
        valuesContent: |-
          global:
            ironicIP: "192.168.122.76"
            enable_tls: false
            enable_vmedia_tls: false
            enable_basicAuth: false
            provisioningInterface: "eth0"
          metal3-ironic:
            service:
              type: NodePort
            persistence:
              ironic:
                storageClass: "longhorn"
          metal3-mariadb:
            persistence:
              storageClass: "longhorn"
    name: metal3-helm-chart-bundle.yaml
  targets:
  # Match to your desired cluster, in this case
  # we match only to one cluster
  - clusterName: rke2-slemicro
----
+
Note how we transfer any custom value overrides that we have done in the manually deployed Helm chart to the `HelmChart` config. This is done in order to ensure the same chart configuration after the *replacement*. Also take note, how in addition to the chart overrides we change the `metal3-ironic.service.type` of the chart. This is done in order to illustrate how a chart update can be done as well.

. Apply the chart `Bundles` to your `Rancher Management Cluster`:

** Longhorn:
+
[,bash]
----
kubectl apply -f longhorn-bundle.yaml 
----

** Metal3:
+
[,bash]
----
kubectl apply -f metal3-bundle.yaml
----

After applying the `Bundles` we can see the following:

* `Longhorn` chart has been upgraded to `1.6.1`

* `Metal3` chart used from `https://suse-edge.github.io/charts` has been replaced with `Metal3` chart from `oci://registry.suse.com/edge/metal3-chart`
+
.Helm charts as seen in Rancher
image::day2-helm-upgrade-2.png[]

To track the upgrade/replacement process of a Helm chart you can look at the logs of the `helm-install-<chart>` Pod in your Helm chart's namespace:

image::day2-helm-upgrade-3.png[]